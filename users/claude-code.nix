{
  inputs,
  lib,
  config,
  pkgs,
  ...
}:

{
  config = {
    home.packages = with pkgs; [
      csharp-ls
    ];

    # Create marketplace structure
    home.file.".claude-plugins/.claude-plugin/marketplace.json".text = builtins.toJSON {
      name = "local-plugins";
      owner.name = "Local Configuration";
      plugins = [
        {
          name = "csharp-lsp";
          source = "./plugins/csharp-lsp";
          description = "C# language server providing code intelligence and diagnostics";
        }
      ];
    };

    # Create the plugin
    home.file.".claude-plugins/plugins/csharp-lsp/.claude-plugin/plugin.json".text = builtins.toJSON {
      name = "csharp-lsp";
      version = "1.0.0";
      description = "C# language server providing code intelligence and diagnostics";
      author.name = "Local Configuration";
      lspServers = "./.lsp.json";
    };

    home.file.".claude-plugins/plugins/csharp-lsp/.lsp.json".text = builtins.toJSON {
      csharp = {
        command = "${pkgs.csharp-ls}/bin/csharp-ls";
        args = [ ];
        extensionToLanguage = {
          ".cs" = "csharp";
        };
        restartOnCrash = true;
        maxRestarts = 5;
      };
    };

    # Register the marketplace and enable the plugin
    home.file.".claude/settings.json".text = builtins.toJSON {
      extraKnownMarketplaces = {
        local-plugins = {
          source = {
            source = "directory";
            path = "${config.home.homeDirectory}/.claude-plugins";
          };
        };
      };
      enabledPlugins = {
        "csharp-lsp@local-plugins" = true;
      };
    };

    home.file.".claude/CLAUDE.md".text = ''
    - commit regularly to checkpoint changes
    - add co-authored-by to commit messages but do not add 'Generated by Claude Code'
    - use gh cli to read contents of issues and pull requests. fetch both description and comments
    - do not add github issue references to commit messages
    '';
  };
}
